\documentclass[12pt]{article}
 
\usepackage[margin=1in]{geometry} 
\usepackage{amsmath,amsthm,amssymb,bm}
\usepackage{graphicx}
\usepackage[numbers]{natbib}
 
\begin{document}
  
\title{Task 4. Cloth Rendering}
\author{Garoe Dorta-Perez\\
CM50245: Computer Animation and Games II}
 
\maketitle
 
\section{Introduction}

Rendering realistic images is a challenging task, specially if there are memory or time constrains for the computation.
Cloth is a complex material composed of interwoven threads of different types.
Moreover, its appearance can vary from diffuse to highly specular.

\section{Previous work}

Solving global illumination generally involves providing a solution to the rendering equation \cite{Kajiya1986}.
One of the earliest approaches was based on simple empirical shading models \cite{Weft1986}.
The main objective was to accomplish believe shading, disregarding physical accuracy.

The methods can be broadly divided into three groups, data based models, geometric models and volumetric models.

The data based approach focuses on collecting reflectance information, that will be later used to model the cloth.
Bidirectional Texture Function (BTF) \cite{Dana1999} is a function that is often used to sampled in the data based techniques.

Geometric models focus on simulation the micro-geometry of the cloth in conjunction with global illumination.
The light scattering is simulated for each fibre in the thread, where the fibres are modelled as perfect cylinders.
To be able to model the the complete scattering effects on a surface, Bidirectional Scattering-Surface Reflectance Distribution Function (BSSRDF) \cite{NicodemusFredEandRichmond1977} have been used.
With this function, complex light phenomena like subsurface scattering are modelled.

\section{Methodology}

\subsection{Shading model}
\label{sec:shading_model}
We have chosen to implement a recent paper \cite{Sadeghi2013} which presents a microcylinder based model for fast and realistic cloth rendering.
The authors propose a model of fabric based on two microcylinders oriented in two orthogonal directions, as shown in Figure \ref{fig:microcylinders}.
\citeauthor{Sadeghi2013} define the reflectance model for a single thread in the fabric as

\begin{figure}[ht!]
\begin{minipage}[b]{.45\textwidth}
\centering
\includegraphics[width=1\textwidth]{images/microcylinders}
	\caption{\citeauthor{Sadeghi2013} shading model \cite{Sadeghi2013}, where $\boldsymbol{\omega_i}$ is the incident light direction, $\mathbf{n}$ is the surface normal and $\mathbf{t_1},\mathbf{t_2}$ are the orthogonal thread directions.}
	\label{fig:microcylinders}
\end{minipage}
\hfill
\begin{minipage}[b]{.45\textwidth}
\centering
\includegraphics[width=1\textwidth]{images/cloth_directions}
	\caption{\citeauthor{Sadeghi2013} shading model \cite{Sadeghi2013}, showing $\theta$ and $\phi$ angles given a pair of directions $\boldsymbol{\omega_i}$ and $\boldsymbol{\omega_r}$.}
	\label{fig:cloth_directions}
\end{minipage}
\end{figure}

\begin{equation}
L_r = \int \frac{\left(f_{r,s}(\mathbf{t}, \boldsymbol{\omega_i}, \boldsymbol{\omega_r}) + f_{r,v}(\mathbf{t},\boldsymbol{\omega_i},\boldsymbol{\omega_r})\right)L_i(\boldsymbol{\omega_i})cos(\theta_i)\delta \boldsymbol{\omega_i}}{cos^2(\theta_d)},
\label{eq:full_model}
\end{equation}

where $\mathbf{t}$ is the thread direction, $\boldsymbol{\omega_i}$ is the ray incoming direction, $\boldsymbol{\omega_r}$ is the ray outgoing direction, $\theta_i, ~\theta_r, ~ \phi_i \mbox{ and } \phi_r$ are angles as shown in Figure \ref{fig:cloth_directions},  $\theta_d = \theta_i-\theta_r$ and $L_i$ is the incoming irradiance in the evaluated point.
Note that radiometric notation \cite{Marschner2003} is used to define $L_r$, which represents the outgoing radiance over a infinitesimal arc length of the cylinder and how the integral extends over the entire sphere instead of the typical hemisphere.

The surface reflection term in Equation \ref{eq:full_model} is defined as

\begin{equation}
f_{r,s}(\mathbf{t}, \boldsymbol{\omega_i}, \boldsymbol{\omega_r}) = F_r(\eta, \boldsymbol{\omega_i}) cos(\phi_d/2)g(\gamma_s, \theta_h),
\end{equation}

where $\theta_h = (\theta_i+\theta_r)/2$, $\phi_d = \phi_i-\phi_r$, $F_r$ is a Fresnel reflection term that is computed using \citeauthor{Schlick1994}'s approximation \cite{Schlick1994} $F_r(\eta, \boldsymbol{\omega_i}) = \eta + (1 - \eta)(1 - \mathbf{h} \cdot \boldsymbol{\omega_i})^5$ where $\cdot$ is the vector dot product operator, $\mathbf{h} = (\boldsymbol{\omega_i} + \boldsymbol{\omega_r})/ \left|\boldsymbol{\omega_i} + \boldsymbol{\omega_r} \right|$ is the normalized halfway vector, $\eta$ is the reflectance for $\mathbf{h} \cdot \boldsymbol{\omega_i} = 1$, $g(\gamma, \theta) = \gamma \mathrm{e} ^{\mathbf{v} \cdot \mathbf{p}-1}$ is a Gaussian lobe \cite{Wang2009} where $\mathbf{p}$ is the lobe axis, the direction $\mathbf{v}$ is the spherical parameter in the resulting function and $\gamma$ is the amplitude.

The volume scattering term in Equation \ref{eq:full_model} is defined as

\begin{equation}
f_{r,v}(\mathbf{t},\boldsymbol{\omega_i},\boldsymbol{\omega_r}) = F_t(\eta, \boldsymbol{\omega_i}) F_t(\eta', \boldsymbol{\omega_r}') \frac{(1-k_d)g(\gamma_v, \theta_h)+k_d}{cos(\theta_i) + cos(\theta_r)} \mathbf{k_a},
\end{equation}

where $k_d$ is a scattering constant, $\mathbf{k_a}$ is an rgb albedo constant vector, $F_t = 1 - F_r$ is a Fresnel transmission term, $\boldsymbol{\omega_r}'$ is a projection of $\boldsymbol{\omega_r}$ into a plane that contains the normal $\mathbf{n}$ and $\eta'$ is computed using the Bravais index \cite{Marschner2003} as $\eta'(m) = \sqrt{\eta^2 - sin^2(m)}  / cos(m)$ where $m$ is the angle between $\boldsymbol{\omega_r}$ and its projection $\boldsymbol{\omega_r}'$.

The outgoing radiance in the path shown in Figure \ref{fig:cloth_directions} is

\begin{equation}
L_r(\boldsymbol{\omega_r}) = a_1 L_{r,1}(\boldsymbol{\omega_r}) + a_2 L_{r,2}(\boldsymbol{\omega_r}),
\end{equation}

where $a_1$ and $a_2$ are the area coverage ratio for the first and second thread within the patch, in our case we assume a watertight pattern of equally size threads, leading to $a_1 = a_2 = 0.5$, $L_1$ and $l_2$ are the outgoing radiances for the first and second thread computed as shown in Equation \ref{eq:full_model}.

In order to compute a thread direction $\mathbf{t}$ without using external data structures, we follow a fixed texture axis as shown in Figure \ref{fig:thread_uv_coord}.
Given an intersection point in a triangle $\mathbf{p} = \left[ x_p, y_p,z_p \right]$ and its texture coordinates $\mathbf{u} = \left[ u_p, v_p \right]$.
We define $\mathbf{t}$ vector as the vector $\mathbf{t} = (\hat{\mathbf{p}} - \mathbf{p})/ \left|\hat{\mathbf{p}} + \mathbf{p} \right|$ such that $\hat{\mathbf{p}}$ texture coordinates are $\hat{\mathbf{u}} = \left[ u_p + 1, v_p \right]$.
In our shader we can easily compute the texture coordinates of the triangle vertices, however we can not immediately get a world position from a new texture coordinate.
Assuming that the 3d to texture transformation is an affine matrix $T$,

\begin{equation}
\mathbf{u} T = \mathbf{p} \rightarrow
\begin{pmatrix}
u & v
\end{pmatrix}
\begin{pmatrix}
a & b & c \\
d & e & f
\end{pmatrix} =
\begin{pmatrix}
x & y & z
\end{pmatrix}
\label{eq:uv_to_3d}
\end{equation}

\begin{figure}[ht!]
\centering
\includegraphics[width=\textwidth]{images/thread_3d_coord}
	\caption{To compute the vector $\mathbf{t}$, we follow the texture coordinates of the intersection point $\mathbf{p}$.}
	\label{fig:thread_uv_coord}
\end{figure}

The system in Equation \ref{eq:uv_to_3d} has six unknowns and three equations, therefore we need two pairs of world points - texture coordinates to solve $T$.
Writing out the terms for two known points $\mathbf{p}_1$ and $\mathbf{p}_2$ in the triangle,

\begin{equation}
\begin{split}
x_1 = u_1 a + v_1 d, \quad y_1 = u_1 b + v_1 e, \quad z_1 = u_1 c + v_1 f,\\
x_2 = u_2 a + v_2 d, \quad y_2 = u_2 b + v_2 e, \quad z_2 = u_2 c + v_2 f.
\end{split}
\end{equation}

Solving for each term analytically,

%a &= \frac{x_1 - v_1 d}{u_1} \quad a = \frac{x_2 - v_2 d}{u_2} \\
\begin{align}
d& = \frac{u_2 x_1 - u_1 x_2}{u_2 v_1 - u_1 v_2},& e& = \frac{u_2 y_1 - u_1 y_2}{u_2 v_1 - u_1 v_2},& f& = \frac{u_2 z_1 - u_1 z_2}{u_2 v_1 - u_1 v_2}, \\
a& = \frac{x_1 - v_1 d}{u_1},& b& = \frac{y_1 - v_1 e}{u_1},&  c& = \frac{z_1 - v_1 f}{u_1}.
\end{align}

Notice that the term of $1/(u_2 v_1 - u_1 v_2)$ is shared, so it can be precomputed in order to increase performance.
The aforementioned method will give $\mathbf{t}_1$, for $\mathbf{t}_2$ the process is equivalent with the exception that $\hat{\mathbf{u}}$ will be incremented on the $v$ direction, $\hat{\mathbf{u}} = \left[ u_p, v_p + 1\right]$.

\subsection{Implementation considerations}

In order to compute more easily quantities such as the $\theta$ or $\phi$ angles introduced in the previous section, we will defined a new coordinate system with the vectors $\left\lbrace \mathbf{t},\mathbf{n},\mathbf{s} \right\rbrace$, whose centre will be the triangle ray-intersection point $\mathbf{p}$, where $\mathbf{s}$ is a normalized vector $\mathbf{s} = \mathbf{n} \times \mathbf{t}$ and $\times$ is the vector cross product operator.
The matrix that will transform from world coordinates to this system is

\begin{equation}
M = M_{trans}M_{rot} =
\begin{pmatrix}
1 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 \\
0 & 0 & 1 & 0 \\
-p_x & -p_y & -p_z & 1 \\
\end{pmatrix}
\begin{pmatrix}
t_x & n_x & s_x & 0 \\
t_y & n_y & s_y & 0 \\
t_z & n_z & s_z & 0 \\
0 & 0 & 0 & 1 \\
\end{pmatrix},
\end{equation}

such that $\mathbf{x}M=\mathbf{x}'_{new}$, where $\mathbf{x}$ is the original row vector in homogeneous coordinates and $\mathbf{x}'_{new}$ is the transformed vector.

We decided to implement the shader in Maya's\texttrademark Mental Ray\texttrademark rendering software.
The rationale under this choice lays in the advantages of integrating work in a established framework, which allows us to easily use the shader for a dynamic cloth simulation.
Mental Ray\texttrademark approximates \citeauthor{Kajiya1986}'s equation \cite{Kajiya1986} using photon mapping \cite{Jensen1996}.
Our approach is to compute an initial estimate of the outgoing radiance $L_{ri}$ for each direct hit during the raytracing path.
In the photon map construction stage each photon hit will locally sample $L_{ri}$ using Equation \ref{eq:full_model}, from this samples an average irradiance will be evaluated, which will then be added to the initial estimate as shown below

\begin{equation}
L_r = L_{ri} + \sum_{i = 1}^{I} \psi_i L_{ri},
\end{equation}

where $I$ is the total number of photons inside a fixed radius around $\mathbf{p}$ and $\psi_i$ is the normalized flux of the ith photon, which is computed from an initial arbitrary flux shared by all photons and decreases with an absorption rate per bounce.

TODO Add analysis of the current paper, what is it based on, what is it actually modelling, what are the limitations, etc

\section{Results}

\section{Conclusion and Future Work}

\bibliographystyle{plainnat}
\bibliography{t4_report}

\end{document}

